# Treeland 应用程序压力测试工具

这个工具用于测试 Wayland 合成器对频繁启动和关闭应用程序的处理能力。它会从预定义的应用程序列表中随机选择程序启动，可以控制启动间隔和最大进程数。

## 功能特点

- 随机启动预定义的应用程序列表
- 可配置的启动间隔时间
- 可限制最大同时运行的进程数
- 自动清理已退出的进程
- 详细的测试统计信息
- 支持设置测试持续时间
- **新增**: 默认启用treeland合成器状态监控，如果treeland意外退出会暂停脚本运行并保持应用程序打开

## 使用方法

基本用法：
```bash
./test_apps.py
```

使用自定义参数：
```bash
# 使用0.5秒的启动间隔，最多同时运行5个进程
./test_apps.py --interval 0.5 --max-processes 5

# 禁用treeland状态监控
./test_apps.py --no-monitor-treeland

# 运行30秒后自动停止
./test_apps.py --duration 30

# 组合使用多个参数
./test_apps.py --interval 0.2 --max-processes 8 --duration 60
```

### 命令行参数

- `--interval <秒数>`：应用程序启动间隔（默认：0.1秒）
- `--max-processes <数量>`：最大同时运行的进程数（默认：10个）
- `--duration <秒数>`：测试持续时间（默认：0，表示持续运行直到中断）
- `--no-monitor-treeland`：禁用treeland合成器状态监控（默认启用监控）

## 内置应用程序列表

脚本内置了以下应用程序：
- `foot` - 终端模拟器
- `deepin-terminal` - 深度终端
- `deepin-compressor` - 深度压缩工具
- `xterm` - X终端模拟器
- `d-spy` - D-Bus 检查工具

应用程序列表可以通过编辑脚本中的 `app_list` 变量来修改。

## 系统要求

- Python 3.6 或更高版本
- psutil 库（用于进程管理）
- 被测试的应用程序需要已经安装在系统中

## 安装

1. 安装必要的 Python 包：
   ```bash
   pip install psutil
   ```

2. 确保脚本具有执行权限：
   ```bash
   chmod +x test_apps.py
   ```

## treeland 监控功能

默认情况下，脚本会启用treeland合成器监控功能：

- 脚本启动时会自动查找treeland进程
- 在测试过程中持续检查treeland状态
- 如果检测到treeland进程退出，会输出详细的崩溃日志并**暂停脚本运行**
- 崩溃时所有已启动的应用程序进程会保持运行状态，脚本不再启动新应用
- 用户需要按 Ctrl+C 手动退出脚本（不会清理应用程序）
- 使用 `--no-monitor-treeland` 参数可以完全禁用监控功能

### treeland崩溃时的行为

当检测到treeland崩溃时，脚本会：
1. 输出包含时间戳的详细崩溃日志
2. 显示当前运行的应用程序数量和PID列表
3. 暂停脚本运行，不再启动新的应用程序
4. 保持所有已启动的应用程序继续运行
5. 等待用户按 Ctrl+C 退出（退出时不会清理应用程序）

## 注意事项

1. 运行测试前请确保系统有足够的资源
2. 建议先用较大的启动间隔进行测试，再逐步减小间隔
3. 如果系统资源紧张，可以通过 `--max-processes` 限制同时运行的进程数
4. 可以随时按 Ctrl+C 中断测试，脚本会自动清理所有启动的进程
5. 默认启用treeland监控，如果未找到treeland进程，测试仍会继续进行
6. **重要**：treeland崩溃时脚本会暂停，应用程序保持运行，需要手动清理或重启treeland

## 输出信息

脚本运行时会显示：
- 测试配置信息
- treeland进程状态（如果启用监控）
- 每个应用程序的启动状态
- 当前运行的进程数量
- treeland崩溃检测信息（如果发生）
- 测试完成后的统计信息

### treeland崩溃时的输出示例

```
🔥 TREELAND 崩溃检测 🔥
时间: 2025-09-02 15:01:21
treeland PID 1087 已退出
当前运行的应用程序: 10 个
应用程序PID列表: [8069, 8102, 8138, 8173, 8226, 8287, 8308, 8341, 8353, 8419]
脚本将暂停运行，不再启动新应用程序
应用程序进程保持运行状态，等待开发者处理
提示: 按 Ctrl+C 退出脚本（不会清理应用程序）
============================================================
treeland已崩溃，脚本暂停运行，应用程序保持打开状态...
按 Ctrl+C 退出脚本
```

## 许可证

使用 MIT 许可证
